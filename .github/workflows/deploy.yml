# Git-FTP Deployment (100% FREE - No SSH needed)
# File: .github/workflows/git-ftp-deploy.yml

name: Git-FTP Deploy (Free)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Git-FTP Deployment
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Get full history for git-ftp

      - name: Install Git-FTP
        run: |
          sudo apt-get update
          sudo apt-get install -y git-ftp curl

      - name: Configure Git-FTP
        run: |
          # Configure git-ftp with WebSupport.sk settings (properly escaped)
          git config git-ftp.url "ftp://${{ secrets.FTP_HOST }}/palacebar.sk/web"
          git config git-ftp.user "${{ secrets.FTP_USERNAME }}"
          git config git-ftp.password "${{ secrets.FTP_PASSWORD }}"
          
          # Set FTP options for WebSupport.sk compatibility  
          git config git-ftp.syncroot "./"
          git config git-ftp.insecure "true"

      - name: Initialize Git-FTP (First time only)
        continue-on-error: true
        run: |
          echo "🔄 Trying to initialize git-ftp..."
          git ftp init 2>/dev/null || echo "Already initialized, will push instead"

      - name: Deploy Changes with Git-FTP
        run: |
          echo "🚀 Deploying changes..."
          echo "Debug: Checking git-ftp config..."
          git config git-ftp.url
          git config git-ftp.user
          echo "Starting deployment..."
          git ftp push 2>&1 || {
            echo "⚠️ Push failed, trying catchup..."
            git ftp catchup 2>&1 || {
              echo "⚠️ Catchup failed, forcing sync..."
              git ftp push --force
            }
          }
          echo "✅ Deployment completed!"

      - name: Verify Deployment
        run: |
          echo "🎉 Website should be live at: https://palacebar.sk/"
          echo "📋 Deployment details:"
          echo "  • Method: Git-FTP (Free)"
          echo "  • Target: /palacebar.sk/web"
          echo "  • Time: $(date)"
          echo "  • Commit: ${{ github.sha }}"
